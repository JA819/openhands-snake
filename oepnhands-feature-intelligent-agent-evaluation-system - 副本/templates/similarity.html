{% extends "base.html" %}

{% block title %}相似度评分 - 智能体评估系统{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">相似度评分</h1>
        <p class="card-subtitle">计算智能体回答与标准答案的相似度</p>
    </div>
    
    <form id="similarityForm">
        <div class="row">
            <div class="col-2">
                <div class="form-group">
                    <label class="form-label">上传测试结果文件</label>
                    <div class="file-upload" id="fileUpload">
                        <p>点击或拖拽上传测试结果文件</p>
                        <p style="font-size: 0.8rem; color: #666;">支持XLSX格式</p>
                    </div>
                    <div id="fileList" class="mt-2"></div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="startBtn">开始计算</button>
            <button type="button" class="btn btn-danger hidden" id="stopBtn">停止计算</button>
        </div>
    </form>
</div>

<!-- 进度显示 -->
<div class="card hidden" id="progressCard">
    <div class="card-header">
        <h2 class="card-title">计算进度</h2>
    </div>
    
    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    
    <div class="mt-3">
        <div id="statusText" class="mb-2">
            <strong>状态：</strong><span id="statusSpan">准备中...</span>
        </div>
        <div id="taskId" class="mb-2">
            <strong>任务ID：</strong><span id="taskIdText">-</span>
        </div>
        <div id="calculationProgress" class="mb-2">
            <strong>计算进度：</strong><span id="progressText">0/0</span>
        </div>
    </div>
</div>

<!-- 结果显示 -->
<div class="card hidden" id="resultCard">
    <div class="card-header">
        <h2 class="card-title">相似度评分结果</h2>
    </div>
    
    <div id="resultContent">
        <!-- 动态生成结果内容 -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTaskId = null;
let taskPoller = null;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化文件上传
    const fileUpload = new SimilarityFileUpload('#fileUpload');
    
    // 表单提交
    document.getElementById('similarityForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const files = fileUpload.getFiles();
        
        if (files.length === 0) {
            Message.error('请上传文件');
            return;
        }
        
        await startCalculation(e);
    });
});

class SimilarityFileUpload extends FileUpload {
    constructor(element) {
        super(element, {
            accept: '.xlsx',
            multiple: false
        });
    }
    
    onFilesSelected(files) {
        this.displayFiles(files);
        // 清空已有文件选择
        document.getElementById('existingFileSelect').value = '';
    }
    
    displayFiles(files) {
        const fileList = document.getElementById('fileList');
        if (files.length > 0) {
            const file = files[0];
            fileList.innerHTML = `
                <div class="alert alert-info" style="padding: 0.5rem; margin: 0.25rem 0;">
                    <small>${file.name} (${Utils.formatFileSize(file.size)})</small>
                </div>
            `;
        } else {
            fileList.innerHTML = '';
        }
    }
    
    clearFiles() {
        this.fileInput.value = '';
        this.displayFiles([]);
    }
}

async function startCalculation(event) {
    event.preventDefault();
    const form = document.getElementById('similarityForm');
    const formData = new FormData(form);
    
    try {
        Loading.show(document.getElementById('startBtn'), '计算中...');
        
        const response = await API.postForm('/api/similarity/calculate', formData);
        const taskId = response.task_id;
        
        // 显示进度
        document.getElementById('progressCard').classList.remove('hidden');
        document.getElementById('resultCard').classList.add('hidden');
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        
        // 开始轮询任务状态
        startPolling(taskId);
        
    } catch (error) {
        console.error('计算失败:', error);
        Message.error('计算失败: ' + error.message);
    } finally {
        Loading.hide(document.getElementById('startBtn'), '开始计算');
    }
}

// ...existing code...
</script>
{% endblock %}