{% extends "base.html" %}

{% block title %}ç»“æœåˆ†æ - æ™ºèƒ½ä½“è¯„ä¼°ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">ç»“æœåˆ†æ</h1>
        <p class="card-subtitle">è¯¦ç»†çš„ç­”æ¡ˆå¯¹æ¯”å’Œè¯„åˆ†åˆ†æ</p>
    </div>
    
    <div class="row">
        <div class="col-2">
            <div class="form-group">
                <label class="form-label">æœç´¢ç›¸ä¼¼åº¦è¯„åˆ†æ–‡ä»¶</label>
                <input type="text" class="form-control" id="fileSearch" placeholder="æœç´¢æ–‡ä»¶å...">
            </div>
            
            <div class="form-group">
                <label class="form-label">é€‰æ‹©åˆ†ææ–‡ä»¶</label>
                <select class="form-control form-select" id="fileSelect">
                    <option value="">é€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶</option>
                </select>
                <button type="button" class="btn btn-secondary mt-2" onclick="loadAnalysisFiles()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
            </div>
        </div>
        
        <div class="col-2">
            <div class="form-group">
                <label class="form-label">é€‰æ‹©æ™ºèƒ½ä½“</label>
                <select class="form-control form-select" id="agentSelect">
                    <option value="">é€‰æ‹©è¦æŸ¥çœ‹çš„æ™ºèƒ½ä½“</option>
                </select>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="loadAnalysis()">å¼€å§‹åˆ†æ</button>
                <button type="button" class="btn btn-secondary" onclick="compareAgents()">å¯¹æ¯”æ™ºèƒ½ä½“</button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æç»“æœæ¦‚è§ˆ -->
<div class="card hidden" id="overviewCard">
    <div class="card-header">
        <h2 class="card-title">åˆ†ææ¦‚è§ˆ</h2>
    </div>
    
    <div id="overviewContent">
        <!-- åŠ¨æ€ç”Ÿæˆæ¦‚è§ˆå†…å®¹ -->
    </div>
</div>

<!-- æ™ºèƒ½ä½“å¯¹æ¯” -->
<div class="card hidden" id="comparisonCard">
    <div class="card-header">
        <h2 class="card-title">æ™ºèƒ½ä½“å¯¹æ¯”</h2>
    </div>
    
    <div id="comparisonContent">
        <!-- åŠ¨æ€ç”Ÿæˆå¯¹æ¯”å†…å®¹ -->
    </div>
</div>

<!-- è¯¦ç»†å¯¹æ¯” -->
<div class="card hidden" id="detailCard">
    <div class="card-header">
        <h2 class="card-title">è¯¦ç»†å¯¹æ¯”</h2>
        <div>
            <select class="form-control form-select" id="questionSelect" style="width: 400px; display: inline-block;">
                <option value="">é€‰æ‹©è¦æŸ¥çœ‹çš„é—®é¢˜</option>
            </select>
            <select class="form-control form-select" id="sortSelect" style="width: 200px; display: inline-block; margin-left: 10px;">
                <option value="score_desc">æŒ‰è¯„åˆ†é™åº</option>
                <option value="score_asc">æŒ‰è¯„åˆ†å‡åº</option>
                <option value="question">æŒ‰é—®é¢˜é¡ºåº</option>
            </select>
        </div>
    </div>
    
    <div id="detailContent">
        <!-- åŠ¨æ€ç”Ÿæˆè¯¦ç»†å†…å®¹ -->
    </div>
</div>

<!-- æ€§èƒ½æ´å¯Ÿ -->
<div class="card hidden" id="insightCard">
    <div class="card-header">
        <h2 class="card-title">æ€§èƒ½æ´å¯Ÿ</h2>
    </div>
    
    <div id="insightContent">
        <!-- åŠ¨æ€ç”Ÿæˆæ´å¯Ÿå†…å®¹ -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAnalysisData = null;
let currentQuestions = [];

document.addEventListener('DOMContentLoaded', function() {
    loadAnalysisFiles();
    
    // æ–‡ä»¶æœç´¢
    document.getElementById('fileSearch').addEventListener('input', filterFiles);
    
    // æ–‡ä»¶é€‰æ‹©å˜åŒ–
    document.getElementById('fileSelect').addEventListener('change', function() {
        if (this.value) {
            loadFileAgents(this.value);
        } else {
            document.getElementById('agentSelect').innerHTML = '<option value="">é€‰æ‹©è¦æŸ¥çœ‹çš„æ™ºèƒ½ä½“</option>';
        }
    });
    
    // é—®é¢˜é€‰æ‹©å˜åŒ–
    document.getElementById('questionSelect').addEventListener('change', showQuestionDetail);
    
    // æ’åºå˜åŒ–
    document.getElementById('sortSelect').addEventListener('change', updateQuestionList);
});

async function loadAnalysisFiles() {
    try {
        const files = await API.get('/api/analysis/files');
        const select = document.getElementById('fileSelect');
        
        // æ¸…ç©ºé€‰é¡¹
        select.innerHTML = '<option value="">é€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶</option>';
        
        files.forEach(file => {
            const option = document.createElement('option');
            option.value = file.name;
            option.textContent = `${file.name} (${Utils.formatDate(file.modified_at)})`;
            select.appendChild(option);
        });
        
        if (files.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'æš‚æ— å¯åˆ†æçš„æ–‡ä»¶';
            option.disabled = true;
            select.appendChild(option);
        }
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ææ–‡ä»¶å¤±è´¥:', error);
        Message.error('åŠ è½½åˆ†ææ–‡ä»¶å¤±è´¥');
    }
}

function filterFiles() {
    const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
    const select = document.getElementById('fileSelect');
    const options = select.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === '') return; // è·³è¿‡é»˜è®¤é€‰é¡¹
        
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
}

async function loadFileAgents(filename) {
    try {
        const analysisData = await API.get(`/api/analysis/${filename}`);
        currentAnalysisData = analysisData;
        
        const agentSelect = document.getElementById('agentSelect');
        agentSelect.innerHTML = '<option value="">é€‰æ‹©è¦æŸ¥çœ‹çš„æ™ºèƒ½ä½“</option>';
        
        if (analysisData.agents) {
            Object.keys(analysisData.agents).forEach(agentName => {
                const option = document.createElement('option');
                option.value = agentName;
                option.textContent = agentName;
                agentSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥:', error);
        Message.error('åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥');
    }
}

async function loadAnalysis() {
    const filename = document.getElementById('fileSelect').value;
    const agentName = document.getElementById('agentSelect').value;
    
    if (!filename) {
        Message.error('è¯·é€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶');
        return;
    }
    
    try {
        if (!currentAnalysisData) {
            currentAnalysisData = await API.get(`/api/analysis/${filename}`);
        }
        
        showOverview(currentAnalysisData, agentName);
        showComparison(currentAnalysisData);
        showInsights(currentAnalysisData);
        
        if (agentName) {
            loadQuestions(filename, agentName);
        }
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥:', error);
        Message.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥');
    }
}

function showOverview(data, selectedAgent) {
    const overviewCard = document.getElementById('overviewCard');
    const overviewContent = document.getElementById('overviewContent');
    
    if (!data.agents || Object.keys(data.agents).length === 0) {
        overviewContent.innerHTML = '<div class="alert alert-warning">æš‚æ— åˆ†ææ•°æ®</div>';
        overviewCard.classList.remove('hidden');
        return;
    }
    
    let html = '<div class="row">';
    
    // æ˜¾ç¤ºæ‰€æœ‰æ™ºèƒ½ä½“çš„ç»Ÿè®¡ä¿¡æ¯
    Object.entries(data.agents).forEach(([agentName, agentData]) => {
        const isSelected = agentName === selectedAgent;
        const cardClass = isSelected ? 'stat-card' : 'stat-card';
        const borderStyle = isSelected ? 'border: 2px solid #667eea;' : '';
        
        html += `
            <div class="col-3">
                <div class="${cardClass}" style="${borderStyle}">
                    <h3>${agentName} ${isSelected ? '(å·²é€‰æ‹©)' : ''}</h3>
                    <div class="stat-number">${agentData.mean_score.toFixed(3)}</div>
                    <div class="stat-label">ç»¼åˆç›¸ä¼¼åº¦è¯„åˆ†å‡å€¼</div>
                    <div class="mt-2">
                        <p><strong>é«˜åˆ†å æ¯”ï¼š</strong>${(agentData.high_score_ratio * 100).toFixed(1)}%</p>
                        <p><strong>ä½åˆ†å æ¯”ï¼š</strong>${(agentData.low_score_ratio * 100).toFixed(1)}%</p>
                        <p><strong>é—®é¢˜æ€»æ•°ï¼š</strong>${agentData.total_questions}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // æœ€ä½³æ™ºèƒ½ä½“æ ‡è¯†
    if (data.best_agent) {
        html += `
            <div class="alert alert-success mt-3">
                <strong>ğŸ† ç»¼åˆç›¸ä¼¼åº¦è¯„åˆ†å‡å€¼æœ€é«˜çš„æ™ºèƒ½ä½“ï¼š${data.best_agent}</strong>
            </div>
        `;
    }
    
    overviewContent.innerHTML = html;
    overviewCard.classList.remove('hidden');
}

function showComparison(data) {
    const comparisonCard = document.getElementById('comparisonCard');
    const comparisonContent = document.getElementById('comparisonContent');
    
    if (!data.comparison || !data.comparison.ranking) {
        comparisonContent.innerHTML = '<div class="alert alert-warning">æš‚æ— å¯¹æ¯”æ•°æ®</div>';
        comparisonCard.classList.remove('hidden');
        return;
    }
    
    let html = `
        <div class="row">
            <div class="col-2">
                <h3>æ™ºèƒ½ä½“æ’å</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æ™ºèƒ½ä½“</th>
                            <th>å¹³å‡åˆ†</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    data.comparison.ranking.forEach((item, index) => {
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
        html += `
            <tr>
                <td>${medal} ${index + 1}</td>
                <td>${item.agent}</td>
                <td>${item.score.toFixed(3)}</td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div class="col-2">
                <h3>è¯„åˆ†åˆ†å¸ƒ</h3>
                <div class="row">
    `;
    
    // æ˜¾ç¤ºæ¯ä¸ªæ™ºèƒ½ä½“çš„è¯„åˆ†åˆ†å¸ƒ
    Object.entries(data.agents).forEach(([agentName, agentData]) => {
        const distribution = agentData.score_distribution;
        html += `
            <div class="col-6" style="margin-bottom: 1rem;">
                <h4>${agentName}</h4>
                <div style="font-size: 0.9rem;">
                    <div>ä¼˜ç§€ (â‰¥0.9): ${distribution.excellent}</div>
                    <div>è‰¯å¥½ (0.7-0.9): ${distribution.good}</div>
                    <div>ä¸€èˆ¬ (0.5-0.7): ${distribution.fair}</div>
                    <div>è¾ƒå·® (<0.5): ${distribution.poor}</div>
                </div>
            </div>
        `;
    });
    
    html += '</div></div></div>';
    
    comparisonContent.innerHTML = html;
    comparisonCard.classList.remove('hidden');
}

async function loadQuestions(filename, agentName) {
    try {
        // è¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–è¯¦ç»†çš„é—®é¢˜æ•°æ®
        // æš‚æ—¶ä½¿ç”¨åˆ†ææ•°æ®ä¸­çš„é—®é¢˜ä¿¡æ¯
        if (currentAnalysisData && currentAnalysisData.agents && currentAnalysisData.agents[agentName]) {
            currentQuestions = currentAnalysisData.agents[agentName].questions || [];
            updateQuestionList();
            document.getElementById('detailCard').classList.remove('hidden');
        }
        
    } catch (error) {
        console.error('åŠ è½½é—®é¢˜æ•°æ®å¤±è´¥:', error);
        Message.error('åŠ è½½é—®é¢˜æ•°æ®å¤±è´¥');
    }
}

function updateQuestionList() {
    const questionSelect = document.getElementById('questionSelect');
    const sortBy = document.getElementById('sortSelect').value;
    
    // æ’åºé—®é¢˜
    let sortedQuestions = [...currentQuestions];
    
    switch (sortBy) {
        case 'score_desc':
            sortedQuestions.sort((a, b) => b.weighted_score - a.weighted_score);
            break;
        case 'score_asc':
            sortedQuestions.sort((a, b) => a.weighted_score - b.weighted_score);
            break;
        case 'question':
            // ä¿æŒåŸé¡ºåº
            break;
    }
    
    // æ›´æ–°é€‰æ‹©æ¡†
    questionSelect.innerHTML = '<option value="">é€‰æ‹©è¦æŸ¥çœ‹çš„é—®é¢˜</option>';
    
    sortedQuestions.forEach((question, index) => {
        const option = document.createElement('option');
        option.value = index;
        const questionText = question.question.length > 50 ? 
            question.question.substring(0, 50) + '...' : question.question;
        option.textContent = `${questionText} (è¯„åˆ†: ${question.weighted_score.toFixed(3)})`;
        questionSelect.appendChild(option);
    });
}

function showQuestionDetail() {
    const questionIndex = document.getElementById('questionSelect').value;
    const detailContent = document.getElementById('detailContent');
    
    if (questionIndex === '' || !currentQuestions[questionIndex]) {
        detailContent.innerHTML = '<div class="alert alert-info">è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„é—®é¢˜</div>';
        return;
    }
    
    const question = currentQuestions[questionIndex];
    
    let html = `
        <div class="row">
            <div class="col">
                <h3>é—®é¢˜</h3>
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="padding: 1rem;">
                        ${question.question}
                    </div>
                </div>
                
                <h3>æ ‡å‡†ç­”æ¡ˆ</h3>
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="padding: 1rem;">
                        ${question.standard_answer}
                    </div>
                </div>
                
                <h3>æ™ºèƒ½ä½“ç­”æ¡ˆ</h3>
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="padding: 1rem;">
                        ${question.generated_answer}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-3">
                <div class="stat-card">
                    <div class="stat-number">${question.cosine_similarity.toFixed(3)}</div>
                    <div class="stat-label">ä½™å¼¦ç›¸ä¼¼åº¦</div>
                </div>
            </div>
            
            <div class="col-3">
                <div class="stat-card">
                    <div class="stat-number">${question.jaccard_similarity.toFixed(3)}</div>
                    <div class="stat-label">Jaccardç›¸ä¼¼åº¦</div>
                </div>
            </div>
            
            <div class="col-3">
                <div class="stat-card">
                    <div class="stat-number">${question.weighted_score.toFixed(3)}</div>
                    <div class="stat-label">ç»¼åˆç›¸ä¼¼åº¦è¯„åˆ†</div>
                </div>
            </div>
        </div>
    `;
    
    detailContent.innerHTML = html;
}

function showInsights(data) {
    const insightCard = document.getElementById('insightCard');
    const insightContent = document.getElementById('insightContent');
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æ´å¯Ÿåˆ†æ
    let html = `
        <div class="row">
            <div class="col-2">
                <h3>æ•´ä½“è¡¨ç°</h3>
                <ul>
                    <li>å‚ä¸è¯„ä¼°çš„æ™ºèƒ½ä½“æ•°é‡ï¼š${Object.keys(data.agents || {}).length}</li>
                    <li>æœ€ä½³è¡¨ç°æ™ºèƒ½ä½“ï¼š${data.best_agent || 'æœªçŸ¥'}</li>
                    <li>å¹³å‡è¯„åˆ†èŒƒå›´ï¼š${getScoreRange(data)}</li>
                </ul>
            </div>
            
            <div class="col-2">
                <h3>æ”¹è¿›å»ºè®®</h3>
                <ul id="recommendations">
                    <!-- åŠ¨æ€ç”Ÿæˆå»ºè®® -->
                </ul>
            </div>
        </div>
    `;
    
    insightContent.innerHTML = html;
    
    // ç”Ÿæˆæ”¹è¿›å»ºè®®
    generateRecommendations(data);
    
    insightCard.classList.remove('hidden');
}

function getScoreRange(data) {
    if (!data.agents || Object.keys(data.agents).length === 0) {
        return 'æ— æ•°æ®';
    }
    
    const scores = Object.values(data.agents).map(agent => agent.mean_score);
    const minScore = Math.min(...scores);
    const maxScore = Math.max(...scores);
    
    return `${minScore.toFixed(3)} - ${maxScore.toFixed(3)}`;
}

function generateRecommendations(data) {
    const recommendationsList = document.getElementById('recommendations');
    const recommendations = [];
    
    if (data.agents) {
        Object.entries(data.agents).forEach(([agentName, agentData]) => {
            if (agentData.low_score_ratio > 0.3) {
                recommendations.push(`${agentName}: ä½åˆ†å›ç­”å æ¯”è¾ƒé«˜ (${(agentData.low_score_ratio * 100).toFixed(1)}%)ï¼Œå»ºè®®ä¼˜åŒ–æ¨¡å‹æˆ–æç¤ºè¯`);
            }
            
            if (agentData.mean_score < 0.6) {
                recommendations.push(`${agentName}: æ•´ä½“è¡¨ç°éœ€è¦æ”¹è¿›ï¼Œå¹³å‡åˆ†ä»…ä¸º ${agentData.mean_score.toFixed(3)}`);
            }
        });
    }
    
    if (recommendations.length === 0) {
        recommendations.push('æ‰€æœ‰æ™ºèƒ½ä½“è¡¨ç°è‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼');
    }
    
    recommendationsList.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
}

async function compareAgents() {
    const filename = document.getElementById('fileSelect').value;
    
    if (!filename) {
        Message.error('è¯·é€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶');
        return;
    }
    
    try {
        if (!currentAnalysisData) {
            currentAnalysisData = await API.get(`/api/analysis/${filename}`);
        }
        
        showComparison(currentAnalysisData);
        Message.success('æ™ºèƒ½ä½“å¯¹æ¯”å®Œæˆ');
        
    } catch (error) {
        console.error('å¯¹æ¯”æ™ºèƒ½ä½“å¤±è´¥:', error);
        Message.error('å¯¹æ¯”æ™ºèƒ½ä½“å¤±è´¥');
    }
}
</script>
{% endblock %}