{% extends "base.html" %}

{% block title %}任务管理 - 智能体评估系统{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">任务管理</h1>
        <p class="card-subtitle">查看和管理系统任务</p>
        <button class="btn btn-secondary" onclick="refreshTasks()">刷新任务列表</button>
    </div>
</div>

<!-- 任务统计 -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">任务统计</h2>
    </div>
    
    <div class="row" id="taskStats">
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">0</div>
                <div class="stat-label">任务总数</div>
            </div>
        </div>
        
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-number" id="runningTasks">0</div>
                <div class="stat-label">运行中</div>
            </div>
        </div>
        
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-number" id="completedTasks">0</div>
                <div class="stat-label">已完成</div>
            </div>
        </div>
    </div>
</div>

<!-- 任务列表 -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">任务列表</h2>
        <div>
            <select class="form-control form-select" id="statusFilter" style="width: 150px; display: inline-block;">
                <option value="">所有状态</option>
                <option value="pending">等待中</option>
                <option value="running">运行中</option>
                <option value="completed">已完成</option>
                <option value="failed">失败</option>
            </select>
            <select class="form-control form-select" id="typeFilter" style="width: 200px; display: inline-block; margin-left: 10px;">
                <option value="">所有类型</option>
                <option value="qa_generation">问答对生成</option>
                <option value="dify_test">Dify测试</option>
                <option value="similarity_calculation">相似度评分</option>
                <option value="full_pipeline">完整流水线</option>
            </select>
        </div>
    </div>
    
    <div id="taskList">
        <table class="table" data-sortable>
            <thead>
                <tr>
                    <th data-sort="id">任务ID</th>
                    <th data-sort="type">任务类型</th>
                    <th data-sort="status">状态</th>
                    <th data-sort="created_at">创建时间</th>
                    <th data-sort="updated_at">更新时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="taskTableBody">
                <!-- 动态生成 -->
            </tbody>
        </table>
    </div>
</div>

<!-- 任务详情模态框 -->
<div id="taskModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">任务详情</h3>
            <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- 动态内容 -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    max-width: 900px;
    width: 90%;
    max-height: 80%;
    overflow-y: auto;
}

.modal-header {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 1rem;
}

.task-type-icon {
    display: inline-block;
    width: 20px;
    height: 20px;
    margin-right: 5px;
    text-align: center;
    font-weight: bold;
    border-radius: 3px;
    color: white;
    font-size: 10px;
    line-height: 20px;
}

.task-type-qa { background-color: #28a745; }
.task-type-dify { background-color: #007bff; }
.task-type-similarity { background-color: #ffc107; color: #333; }
.task-type-pipeline { background-color: #6f42c1; }
</style>
{% endblock %}

{% block extra_js %}
<script>
let allTasks = [];

document.addEventListener('DOMContentLoaded', function() {
    refreshTasks();
    
    // 过滤功能
    document.getElementById('statusFilter').addEventListener('change', filterTasks);
    document.getElementById('typeFilter').addEventListener('change', filterTasks);
    
    // 自动刷新
    setInterval(refreshTasks, 10000); // 每10秒刷新一次
});

async function refreshTasks() {
    try {
        const tasks = await API.get('/api/tasks');
        allTasks = tasks;
        updateTaskStats(tasks);
        displayTasks(tasks);
    } catch (error) {
        console.error('获取任务列表失败:', error);
        Message.error('获取任务列表失败');
    }
}

function updateTaskStats(tasks) {
    const totalTasks = tasks.length;
    const runningTasks = tasks.filter(task => task.status === 'running' || task.status === 'pending').length;
    const completedTasks = tasks.filter(task => task.status === 'completed').length;
    
    document.getElementById('totalTasks').textContent = totalTasks;
    document.getElementById('runningTasks').textContent = runningTasks;
    document.getElementById('completedTasks').textContent = completedTasks;
}

function displayTasks(tasks) {
    const tbody = document.getElementById('taskTableBody');
    
    if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无任务</td></tr>';
        return;
    }
    
    let html = '';
    tasks.forEach(task => {
        const statusClass = getStatusClass(task.status);
        const statusText = getStatusText(task.status);
        const typeIcon = getTaskTypeIcon(task.type);
        const typeText = getTaskTypeText(task.type);
        
        html += `
            <tr>
                <td>
                    <span title="${task.id}">${task.id.substring(0, 8)}...</span>
                </td>
                <td>
                    ${typeIcon}
                    ${typeText}
                </td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>${Utils.formatDate(task.created_at)}</td>
                <td>${Utils.formatDate(task.updated_at)}</td>
                <td>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;" 
                            onclick="viewTaskDetails('${task.id}')">详情</button>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" 
                            onclick="deleteTask('${task.id}')">删除</button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function filterTasks() {
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    let filteredTasks = allTasks;
    
    // 按状态过滤
    if (statusFilter) {
        filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
    }
    
    // 按类型过滤
    if (typeFilter) {
        filteredTasks = filteredTasks.filter(task => task.type === typeFilter);
    }
    
    displayTasks(filteredTasks);
}

function getStatusClass(status) {
    const statusMap = {
        'completed': 'status-success',
        'failed': 'status-error',
        'running': 'status-info',
        'pending': 'status-warning'
    };
    return statusMap[status] || 'status-info';
}

function getStatusText(status) {
    const statusMap = {
        'completed': '已完成',
        'failed': '失败',
        'running': '运行中',
        'pending': '等待中'
    };
    return statusMap[status] || status;
}

function getTaskTypeIcon(type) {
    const iconMap = {
        'qa_generation': '<span class="task-type-icon task-type-qa">QA</span>',
        'dify_test': '<span class="task-type-icon task-type-dify">DF</span>',
        'similarity_calculation': '<span class="task-type-icon task-type-similarity">SM</span>',
        'full_pipeline': '<span class="task-type-icon task-type-pipeline">PL</span>'
    };
    return iconMap[type] || '<span class="task-type-icon" style="background-color: #6c757d;">?</span>';
}

function getTaskTypeText(type) {
    const typeMap = {
        'qa_generation': '问答对生成',
        'dify_test': 'Dify测试',
        'similarity_calculation': '相似度评分',
        'full_pipeline': '完整流水线'
    };
    return typeMap[type] || type;
}

async function viewTaskDetails(taskId) {
    try {
        const task = await API.get(`/api/tasks/${taskId}`);
        
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modal = document.getElementById('taskModal');
        
        modalTitle.textContent = `任务详情 - ${taskId.substring(0, 8)}...`;
        
        let html = `
            <div class="row">
                <div class="col-2">
                    <h4>基本信息</h4>
                    <table class="table">
                        <tr>
                            <td><strong>任务ID：</strong></td>
                            <td>${task.id}</td>
                        </tr>
                        <tr>
                            <td><strong>任务类型：</strong></td>
                            <td>${getTaskTypeText(task.type)}</td>
                        </tr>
                        <tr>
                            <td><strong>状态：</strong></td>
                            <td><span class="status ${getStatusClass(task.status)}">${getStatusText(task.status)}</span></td>
                        </tr>
                        <tr>
                            <td><strong>创建时间：</strong></td>
                            <td>${Utils.formatDate(task.created_at)}</td>
                        </tr>
                        <tr>
                            <td><strong>更新时间：</strong></td>
                            <td>${Utils.formatDate(task.updated_at)}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="col-2">
                    <h4>参数信息</h4>
                    <pre style="background-color: #f8f9fa; padding: 1rem; border-radius: 5px; font-size: 0.8rem;">${JSON.stringify(task.parameters, null, 2)}</pre>
                </div>
            </div>
        `;
        
        if (task.result && Object.keys(task.result).length > 0) {
            html += `
                <div class="mt-3">
                    <h4>执行结果</h4>
                    <pre style="background-color: #f8f9fa; padding: 1rem; border-radius: 5px; font-size: 0.8rem;">${JSON.stringify(task.result, null, 2)}</pre>
                </div>
            `;
            
            // 如果有输出文件，添加下载链接
            if (task.result.output_file) {
                html += `
                    <div class="mt-3">
                        <h4>输出文件</h4>
                        <a href="/api/files/${task.result.output_file.split('/').pop()}" class="btn btn-primary">下载文件</a>
                    </div>
                `;
            }
            
            if (task.result.qa_file || task.result.test_file || task.result.similarity_file) {
                html += '<div class="mt-3"><h4>生成的文件</h4>';
                
                if (task.result.qa_file) {
                    html += `<a href="/api/files/${task.result.qa_file.split('/').pop()}" class="btn btn-secondary mr-2">问答对文件</a>`;
                }
                if (task.result.test_file) {
                    html += `<a href="/api/files/${task.result.test_file.split('/').pop()}" class="btn btn-secondary mr-2">测试结果文件</a>`;
                }
                if (task.result.similarity_file) {
                    html += `<a href="/api/files/${task.result.similarity_file.split('/').pop()}" class="btn btn-secondary mr-2">相似度评分文件</a>`;
                }
                
                html += '</div>';
            }
        }
        
        html += `
            <div class="mt-3">
                <button class="btn btn-secondary" onclick="Utils.copyToClipboard('${task.id}')">复制任务ID</button>
                <button class="btn btn-danger" onclick="deleteTask('${task.id}'); closeModal();">删除任务</button>
            </div>
        `;
        
        modalBody.innerHTML = html;
        modal.style.display = 'flex';
        
    } catch (error) {
        console.error('查看任务详情失败:', error);
        Message.error('查看任务详情失败');
    }
}

async function deleteTask(taskId) {
    if (!confirm(`确定要删除任务 "${taskId.substring(0, 8)}..." 吗？此操作不可撤销。`)) {
        return;
    }
    
    try {
        await API.delete(`/api/tasks/${taskId}`);
        Message.success('任务已删除');
        refreshTasks();
    } catch (error) {
        console.error('删除任务失败:', error);
        Message.error('删除任务失败');
    }
}

function closeModal() {
    document.getElementById('taskModal').style.display = 'none';
}

// 点击模态框外部关闭
document.getElementById('taskModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}