{% extends "base.html" %}

{% block title %}智能体配置 - 智能体评估系统{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">智能体API导入</h1>
        <p class="card-subtitle">配置1-3个智能体进行并行测试</p>
    </div>
    
    <form id="agentConfigForm">
        <div class="form-group">
            <label class="form-label">选择智能体数量</label>
            <select class="form-control form-select" id="agentCount" name="agent_count" required>
                <option value="">请选择智能体数量</option>
                <option value="1">1个智能体</option>
                <option value="2">2个智能体</option>
                <option value="3">3个智能体</option>
            </select>
        </div>
        
        <!-- 智能体1配置 -->
        <div id="agent1Config" class="agent-config hidden">
            <h3>智能体1配置</h3>
            <div class="row">
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">API URL</label>
                        <input type="url" class="form-control" name="agent1_url" placeholder="https://example.com/api/v1/chat">
                    </div>
                </div>
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-control" name="agent1_key" placeholder="Bearer your-api-key">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 智能体2配置 -->
        <div id="agent2Config" class="agent-config hidden">
            <h3>智能体2配置</h3>
            <div class="row">
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">API URL</label>
                        <input type="url" class="form-control" name="agent2_url" placeholder="https://example.com/api/v1/chat">
                    </div>
                </div>
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-control" name="agent2_key" placeholder="Bearer your-api-key">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 智能体3配置 -->
        <div id="agent3Config" class="agent-config hidden">
            <h3>智能体3配置</h3>
            <div class="row">
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">API URL</label>
                        <input type="url" class="form-control" name="agent3_url" placeholder="https://example.com/api/v1/chat">
                    </div>
                </div>
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-control" name="agent3_key" placeholder="Bearer your-api-key">
                    </div>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" id="submitBtn">导入智能体配置</button>
    </form>
</div>

<!-- 智能体状态显示 -->
<div class="card" id="agentStatus" style="display: none;">
    <div class="card-header">
        <h2 class="card-title">智能体状态</h2>
        <button class="btn btn-secondary" onclick="checkAgentStatus()">刷新状态</button>
    </div>
    
    <div id="agentStatusList">
        <!-- 动态生成智能体状态 -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agentCountSelect = document.getElementById('agentCount');
    const agentConfigs = document.querySelectorAll('.agent-config');
    const form = document.getElementById('agentConfigForm');
    
    // 智能体数量选择变化
    agentCountSelect.addEventListener('change', function() {
        const count = parseInt(this.value);
        
        // 隐藏所有配置
        agentConfigs.forEach(config => config.classList.add('hidden'));
        
        // 显示对应数量的配置
        for (let i = 1; i <= count; i++) {
            const config = document.getElementById(`agent${i}Config`);
            if (config) {
                config.classList.remove('hidden');
                // 设置必填
                const inputs = config.querySelectorAll('input');
                inputs.forEach(input => input.required = true);
            }
        }
        
        // 隐藏多余配置的必填要求
        for (let i = count + 1; i <= 3; i++) {
            const config = document.getElementById(`agent${i}Config`);
            if (config) {
                const inputs = config.querySelectorAll('input');
                inputs.forEach(input => input.required = false);
            }
        }
    });
    
    // 表单提交
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        Loading.show(submitBtn, '配置中...');
        
        try {
            const formData = new FormData(form);
            const response = await API.postForm('/api/agents/config', formData);
            
            Message.success('智能体配置成功！');
            
            // 显示状态检查
            setTimeout(() => {
                checkAgentStatus();
            }, 1000);
            
        } catch (error) {
            console.error('配置失败:', error);
            Message.error('配置失败: ' + error.message);
        } finally {
            Loading.hide(submitBtn, originalText);
        }
    });
    
    // 页面加载时检查状态
    checkAgentStatus();
});

async function checkAgentStatus() {
    try {
        const response = await API.get('/api/agents/status');
        
        const statusCard = document.getElementById('agentStatus');
        const statusList = document.getElementById('agentStatusList');
        
        if (response.configured) {
            statusCard.style.display = 'block';
            
            let html = '<div class="row">';
            response.agents.forEach(agent => {
                const statusClass = agent.status === 'connected' ? 'status-success' : 'status-error';
                const statusText = agent.status === 'connected' ? '连接成功' : '连接失败';
                
                html += `
                    <div class="col-3">
                        <div class="stat-card">
                            <h3>${agent.name}</h3>
                            <div class="status ${statusClass}">${statusText}</div>
                            <p class="mt-2" style="font-size: 0.8rem; word-break: break-all;">${agent.url}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            statusList.innerHTML = html;
        } else {
            statusCard.style.display = 'none';
        }
        
    } catch (error) {
        console.error('获取状态失败:', error);
    }
}
</script>
{% endblock %}