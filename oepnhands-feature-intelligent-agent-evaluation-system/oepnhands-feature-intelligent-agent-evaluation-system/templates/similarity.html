{% extends "base.html" %}

{% block title %}ç›¸ä¼¼åº¦è¯„åˆ† - æ™ºèƒ½ä½“è¯„ä¼°ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">ç›¸ä¼¼åº¦è¯„åˆ†</h1>
        <p class="card-subtitle">è®¡ç®—æ ‡å‡†ç­”æ¡ˆä¸Difyç­”æ¡ˆçš„è¯­ä¹‰ç›¸ä¼¼åº¦è¯„åˆ†</p>
    </div>
    
    <form id="similarityForm">
        <div class="row">
            <div class="col-2">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©è¯„ä¼°ç»“æœExcelæ–‡ä»¶</label>
                    <div class="file-upload" id="fileUpload">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</p>
                        <p style="font-size: 0.8rem; color: #666;">æ”¯æŒ.xlsxæ ¼å¼</p>
                    </div>
                    <div id="fileList" class="mt-2"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æˆ–é€‰æ‹©å·²æœ‰æ–‡ä»¶</label>
                    <select class="form-control form-select" id="existingFileSelect">
                        <option value="">é€‰æ‹©å·²æœ‰çš„æµ‹è¯•ç»“æœæ–‡ä»¶</option>
                    </select>
                    <button type="button" class="btn btn-secondary mt-2" onclick="loadExistingFiles()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
                </div>
            </div>
            
            <div class="col-2">
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="text" class="form-control" name="api_key" placeholder="sk-..." required>
                    <small class="form-text">ç”¨äºè°ƒç”¨ç›¸ä¼¼åº¦è®¡ç®—API</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ™ºèƒ½ä½“æ•°é‡</label>
                    <div id="agentCountDisplay" class="form-control" style="background-color: #f8f9fa;">
                        <span id="agentCountText">æ£€æµ‹ä¸­...</span>
                    </div>
                    <small class="form-text">ç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹æ™ºèƒ½ä½“æ•°é‡</small>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="calculateBtn">è®¡ç®—è¯„åˆ†</button>
        </div>
    </form>
</div>

<!-- æ™ºèƒ½ä½“ä¿¡æ¯æ˜¾ç¤º -->
<div class="card" id="agentInfoCard">
    <div class="card-header">
        <h2 class="card-title">æ™ºèƒ½ä½“ä¿¡æ¯</h2>
    </div>
    
    <div id="agentInfoList">
        <!-- åŠ¨æ€ç”Ÿæˆæ™ºèƒ½ä½“ä¿¡æ¯ -->
    </div>
</div>

<!-- è¿›åº¦æ˜¾ç¤º -->
<div class="card hidden" id="progressCard">
    <div class="card-header">
        <h2 class="card-title">è®¡ç®—è¿›åº¦</h2>
    </div>
    
    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    
    <div class="mt-3">
        <div id="statusText" class="mb-2">
            <strong>çŠ¶æ€ï¼š</strong><span id="statusSpan">å‡†å¤‡ä¸­...</span>
        </div>
        <div id="taskId" class="mb-2">
            <strong>ä»»åŠ¡IDï¼š</strong><span id="taskIdText">-</span>
        </div>
        <div id="calculationProgress" class="mb-2">
            <strong>è®¡ç®—è¿›åº¦ï¼š</strong><span id="progressText">0/0</span>
        </div>
    </div>
</div>

<!-- ç»“æœæ˜¾ç¤º -->
<div class="card hidden" id="resultCard">
    <div class="card-header">
        <h2 class="card-title">ç›¸ä¼¼åº¦è¯„åˆ†ç»“æœ</h2>
    </div>
    
    <div id="resultContent">
        <!-- åŠ¨æ€ç”Ÿæˆç»“æœå†…å®¹ -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTaskId = null;
let taskPoller = null;

document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
    const fileUpload = new SimilarityFileUpload('#fileUpload');
    
    // æ£€æŸ¥æ™ºèƒ½ä½“ä¿¡æ¯
    checkAgentInfo();
    
    // åŠ è½½å·²æœ‰æ–‡ä»¶
    loadExistingFiles();
    
    // è¡¨å•æäº¤
    document.getElementById('similarityForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const files = fileUpload.getFiles();
        const existingFile = document.getElementById('existingFileSelect').value;
        
        if (files.length === 0 && !existingFile) {
            Message.error('è¯·ä¸Šä¼ æ–‡ä»¶æˆ–é€‰æ‹©å·²æœ‰æ–‡ä»¶');
            return;
        }
        
        await startSimilarityCalculation();
    });
    
    // å·²æœ‰æ–‡ä»¶é€‰æ‹©å˜åŒ–
    document.getElementById('existingFileSelect').addEventListener('change', function() {
        if (this.value) {
            // æ¸…ç©ºæ–‡ä»¶ä¸Šä¼ 
            fileUpload.clearFiles();
        }
    });
});

class SimilarityFileUpload extends FileUpload {
    constructor(element) {
        super(element, {
            accept: '.xlsx',
            multiple: false
        });
    }
    
    onFilesSelected(files) {
        this.displayFiles(files);
        // æ¸…ç©ºå·²æœ‰æ–‡ä»¶é€‰æ‹©
        document.getElementById('existingFileSelect').value = '';
    }
    
    displayFiles(files) {
        const fileList = document.getElementById('fileList');
        if (files.length > 0) {
            const file = files[0];
            fileList.innerHTML = `
                <div class="alert alert-info" style="padding: 0.5rem; margin: 0.25rem 0;">
                    <small>${file.name} (${Utils.formatFileSize(file.size)})</small>
                </div>
            `;
        } else {
            fileList.innerHTML = '';
        }
    }
    
    clearFiles() {
        this.fileInput.value = '';
        this.displayFiles([]);
    }
}

async function checkAgentInfo() {
    try {
        const response = await API.get('/api/agents/status');
        
        const agentCountText = document.getElementById('agentCountText');
        const agentInfoList = document.getElementById('agentInfoList');
        
        if (!response.configured) {
            agentCountText.textContent = 'æœªé…ç½®';
            agentInfoList.innerHTML = `
                <div class="alert alert-warning">
                    <strong>æœªé…ç½®æ™ºèƒ½ä½“</strong><br>
                    è¯·å…ˆå‰å¾€ <a href="/agents">æ™ºèƒ½ä½“é…ç½®</a> é¡µé¢é…ç½®æ™ºèƒ½ä½“ã€‚
                </div>
            `;
            return;
        }
        
        const agentCount = response.agents.length;
        agentCountText.textContent = `${agentCount} ä¸ªæ™ºèƒ½ä½“`;
        
        let html = '<div class="row">';
        response.agents.forEach(agent => {
            const statusClass = agent.status === 'connected' ? 'status-success' : 'status-error';
            const statusText = agent.status === 'connected' ? 'è¿æ¥æ­£å¸¸' : 'è¿æ¥å¤±è´¥';
            
            html += `
                <div class="col-3">
                    <div class="stat-card">
                        <h4>${agent.name}</h4>
                        <div class="status ${statusClass}">${statusText}</div>
                        <p class="mt-2" style="font-size: 0.8rem;">å°†è®¡ç®—æ­¤æ™ºèƒ½ä½“çš„ç›¸ä¼¼åº¦è¯„åˆ†</p>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        agentInfoList.innerHTML = html;
        
    } catch (error) {
        console.error('è·å–æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('agentCountText').textContent = 'è·å–å¤±è´¥';
    }
}

async function loadExistingFiles() {
    try {
        const files = await API.get('/api/files');
        const select = document.getElementById('existingFileSelect');
        
        // æ¸…ç©ºé€‰é¡¹
        select.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰çš„æµ‹è¯•ç»“æœæ–‡ä»¶</option>';
        
        // è¿‡æ»¤å‡ºå¯èƒ½çš„æµ‹è¯•ç»“æœæ–‡ä»¶
        const testFiles = files.filter(file => 
            file.type === 'excel' && 
            (file.name.includes('test') || file.name.includes('evaluation') || file.name.includes('dify'))
        );
        
        testFiles.forEach(file => {
            const option = document.createElement('option');
            option.value = file.name;
            option.textContent = `${file.name} (${Utils.formatFileSize(file.size)})`;
            select.appendChild(option);
        });
        
        if (testFiles.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'æš‚æ— å¯ç”¨çš„æµ‹è¯•ç»“æœæ–‡ä»¶';
            option.disabled = true;
            select.appendChild(option);
        }
        
    } catch (error) {
        console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
    }
}

async function startSimilarityCalculation() {
    const form = document.getElementById('similarityForm');
    const formData = new FormData(form);
    
    // å¦‚æœé€‰æ‹©äº†å·²æœ‰æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶
    const existingFile = document.getElementById('existingFileSelect').value;
    if (existingFile) {
        // è¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å‘Šè¯‰åç«¯ä½¿ç”¨å·²æœ‰æ–‡ä»¶
        formData.append('existing_file', existingFile);
    }
    
    const calculateBtn = document.getElementById('calculateBtn');
    const progressCard = document.getElementById('progressCard');
    const resultCard = document.getElementById('resultCard');
    
    try {
        Loading.show(calculateBtn, 'å¯åŠ¨ä¸­...');
        
        const response = await API.postForm('/api/similarity/calculate', formData);
        currentTaskId = response.task_id;
        
        // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡
        progressCard.classList.remove('hidden');
        resultCard.classList.add('hidden');
        
        document.getElementById('taskIdText').textContent = currentTaskId;
        document.getElementById('statusSpan').textContent = 'æ­£åœ¨è®¡ç®—ç›¸ä¼¼åº¦...';
        
        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        taskPoller = new TaskPoller(
            currentTaskId,
            updateProgress,
            onComplete
        );
        taskPoller.start();
        
        Message.success('ç›¸ä¼¼åº¦è®¡ç®—ä»»åŠ¡å·²å¯åŠ¨');
        
    } catch (error) {
        console.error('å¯åŠ¨è®¡ç®—å¤±è´¥:', error);
        Message.error('å¯åŠ¨å¤±è´¥: ' + error.message);
    } finally {
        Loading.hide(calculateBtn, 'è®¡ç®—è¯„åˆ†');
    }
}

function updateProgress(task) {
    const progressBar = document.getElementById('progressBar');
    const statusSpan = document.getElementById('statusSpan');
    const progressText = document.getElementById('progressText');
    
    if (task.status === 'running') {
        progressBar.style.width = '50%';
        statusSpan.textContent = 'æ­£åœ¨è®¡ç®—ç›¸ä¼¼åº¦...';
        
        // å¦‚æœæœ‰è¿›åº¦ä¿¡æ¯ï¼Œæ˜¾ç¤ºå…·ä½“è¿›åº¦
        if (task.result && task.result.progress) {
            progressText.textContent = task.result.progress;
        }
    } else if (task.status === 'pending') {
        progressBar.style.width = '10%';
        statusSpan.textContent = 'ä»»åŠ¡æ’é˜Ÿä¸­...';
    }
}

function onComplete(task) {
    const progressBar = document.getElementById('progressBar');
    const statusSpan = document.getElementById('statusSpan');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('resultContent');
    
    if (task.status === 'completed') {
        progressBar.style.width = '100%';
        statusSpan.textContent = 'ç›¸ä¼¼åº¦è¯„åˆ†å®Œæˆï¼';
        
        // æ˜¾ç¤ºç»“æœ
        const result = task.result || {};
        let html = `
            <div class="alert alert-success">
                <strong>ç›¸ä¼¼åº¦è¯„åˆ†å®Œæˆï¼</strong>
            </div>
        `;
        
        // æ˜¾ç¤ºå„æ™ºèƒ½ä½“çš„ç»¼åˆç›¸ä¼¼åº¦è¯„åˆ†å‡å€¼
        if (result.scores && Object.keys(result.scores).length > 0) {
            html += '<div class="row">';
            
            let bestAgent = null;
            let bestScore = -1;
            
            Object.entries(result.scores).forEach(([agentName, scores]) => {
                if (scores.mean_score > bestScore) {
                    bestScore = scores.mean_score;
                    bestAgent = agentName;
                }
                
                html += `
                    <div class="col-3">
                        <div class="stat-card">
                            <div class="stat-number">${scores.mean_score.toFixed(3)}</div>
                            <div class="stat-label">${agentName} ç»¼åˆç›¸ä¼¼åº¦è¯„åˆ†å‡å€¼</div>
                            <div class="mt-2">
                                <small>æœ€é«˜åˆ†: ${scores.max_score.toFixed(3)}</small><br>
                                <small>æœ€ä½åˆ†: ${scores.min_score.toFixed(3)}</small><br>
                                <small>é—®é¢˜æ•°: ${scores.count}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // æ ‡è¯†æœ€ä½³æ™ºèƒ½ä½“
            if (bestAgent) {
                html += `
                    <div class="alert alert-info mt-3">
                        <strong>ğŸ† æœ€ä½³è¡¨ç°æ™ºèƒ½ä½“ï¼š${bestAgent}</strong><br>
                        ç»¼åˆç›¸ä¼¼åº¦è¯„åˆ†å‡å€¼ï¼š${bestScore.toFixed(3)}
                    </div>
                `;
            }
        }
        
        // æ–‡ä»¶ä¸‹è½½é“¾æ¥
        if (result.output_file) {
            html += `
                <div class="mt-3">
                    <h3>è¯„åˆ†ç»“æœæ–‡ä»¶</h3>
                    <table class="table">
                        <tr>
                            <td><strong>æ–‡ä»¶åï¼š</strong></td>
                            <td>${result.output_file.split('/').pop()}</td>
                        </tr>
                        <tr>
                            <td><strong>æ™ºèƒ½ä½“æ•°é‡ï¼š</strong></td>
                            <td>${Object.keys(result.scores || {}).length}</td>
                        </tr>
                        <tr>
                            <td><strong>å®Œæˆæ—¶é—´ï¼š</strong></td>
                            <td>${Utils.formatDate(task.updated_at)}</td>
                        </tr>
                    </table>
                    
                    <div class="mt-3">
                        <a href="/api/files/${result.output_file.split('/').pop()}" class="btn btn-primary">ä¸‹è½½è¯„åˆ†ç»“æœ</a>
                        <a href="/files" class="btn btn-secondary">æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶</a>
                        <a href="/analysis" class="btn btn-success">è¯¦ç»†ç»“æœåˆ†æ</a>
                    </div>
                </div>
            `;
        }
        
        resultContent.innerHTML = html;
        resultCard.classList.remove('hidden');
        
        Message.success('ç›¸ä¼¼åº¦è¯„åˆ†å®Œæˆï¼');
        
    } else if (task.status === 'failed') {
        progressBar.style.width = '100%';
        progressBar.style.backgroundColor = '#dc3545';
        statusSpan.textContent = 'ç›¸ä¼¼åº¦è¯„åˆ†å¤±è´¥';
        
        const error = task.result?.error || 'æœªçŸ¥é”™è¯¯';
        resultContent.innerHTML = `
            <div class="alert alert-error">
                <strong>ç›¸ä¼¼åº¦è¯„åˆ†å¤±è´¥ï¼š</strong>${error}
            </div>
            
            <div class="mt-3">
                <h3>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š</h3>
                <ul>
                    <li>æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®</li>
                    <li>ç¡®è®¤ä¸Šä¼ çš„Excelæ–‡ä»¶æ ¼å¼æ­£ç¡®</li>
                    <li>æ£€æŸ¥æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«æ ‡å‡†ç­”æ¡ˆå’Œæ™ºèƒ½ä½“ç­”æ¡ˆ</li>
                    <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                    <li>å°è¯•ä½¿ç”¨è¾ƒå°çš„æ–‡ä»¶è¿›è¡Œæµ‹è¯•</li>
                </ul>
                
                <button class="btn btn-primary" onclick="location.reload()">é‡æ–°å°è¯•</button>
                <button class="btn btn-secondary" onclick="loadExistingFiles()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
            </div>
        `;
        resultCard.classList.remove('hidden');
        
        Message.error('ç›¸ä¼¼åº¦è¯„åˆ†å¤±è´¥');
    }
    
    currentTaskId = null;
    taskPoller = null;
}
</script>
{% endblock %}