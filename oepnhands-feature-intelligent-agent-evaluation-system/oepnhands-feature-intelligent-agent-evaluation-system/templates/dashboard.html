{% extends "base.html" %}

{% block title %}ç³»ç»Ÿä»ªè¡¨ç›˜ - æ™ºèƒ½ä½“è¯„ä¼°ç³»ç»Ÿ{% endblock %}

{% block page_title %}ğŸ“Š ç³»ç»Ÿä»ªè¡¨ç›˜{% endblock %}
{% block page_description %}ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆå’Œç»Ÿè®¡ä¿¡æ¯{% endblock %}

{% block content %}

<!-- ç³»ç»ŸçŠ¶æ€ -->
<div class="section">
    <h2>ğŸ” ç³»ç»ŸçŠ¶æ€</h2>
    <button class="btn btn-secondary" onclick="refreshDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
    
    <div id="systemStatus">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="systemHealth">æ£€æŸ¥ä¸­...</div>
                <div class="stat-label">ç³»ç»Ÿå¥åº·çŠ¶æ€</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="agentStatus">æ£€æŸ¥ä¸­...</div>
                <div class="stat-label">æ™ºèƒ½ä½“è¿æ¥çŠ¶æ€</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="diskUsage">è®¡ç®—ä¸­...</div>
                <div class="stat-label">ç£ç›˜ä½¿ç”¨æƒ…å†µ</div>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡æ¦‚è§ˆ -->
<div class="section">
    <h2>ğŸ“ˆ ç»Ÿè®¡æ¦‚è§ˆ</h2>
    
    <div id="statsOverview">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">0</div>
                <div class="stat-label">ä»»åŠ¡æ€»æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="completedTasks">0</div>
                <div class="stat-label">å·²å®Œæˆä»»åŠ¡</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="failedTasks">0</div>
                <div class="stat-label">å¤±è´¥ä»»åŠ¡</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="qaGenerationTasks">0</div>
                <div class="stat-label">é—®ç­”å¯¹ç”Ÿæˆ</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="difyTestTasks">0</div>
                <div class="stat-label">Difyæµ‹è¯•</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="similarityTasks">0</div>
                <div class="stat-label">ç›¸ä¼¼åº¦è¯„åˆ†</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="pipelineTasks">0</div>
                <div class="stat-label">å®Œæ•´æµæ°´çº¿</div>
            </div>
        </div>
    </div>
</div>

<!-- æœ€è¿‘ä»»åŠ¡ -->
<div class="section">
    <h2>ğŸ“‹ æœ€è¿‘ä»»åŠ¡</h2>
    
    <div id="recentTasks">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ä»»åŠ¡ID</th>
                    <th>ä»»åŠ¡ç±»å‹</th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="recentTasksBody">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>
    </div>
</div>

<!-- æ–‡ä»¶ç»Ÿè®¡ -->
<div class="section">
    <h2>ğŸ“ æ–‡ä»¶ç»Ÿè®¡</h2>
    
    <div id="fileStats">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalFiles">0</div>
                <div class="stat-label">è¾“å‡ºæ–‡ä»¶æ€»æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="excelFiles">0</div>
                <div class="stat-label">Excelæ–‡ä»¶</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="totalFileSize">0 MB</div>
                <div class="stat-label">æ–‡ä»¶æ€»å¤§å°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="latestFile">æ— </div>
                <div class="stat-label">æœ€æ–°æ–‡ä»¶</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
    
    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
    setInterval(refreshDashboard, 30000);
});

async function refreshDashboard() {
    try {
        // è·å–ç»Ÿè®¡æ•°æ®
        const stats = await API.get('/api/dashboard/stats');
        updateStats(stats);
        
        // è·å–æ™ºèƒ½ä½“çŠ¶æ€
        const agentStatus = await API.get('/api/agents/status');
        updateAgentStatus(agentStatus);
        
        // è·å–æ–‡ä»¶ç»Ÿè®¡
        const files = await API.get('/api/files');
        updateFileStats(files);
        
        // æ›´æ–°ç³»ç»Ÿå¥åº·çŠ¶æ€
        updateSystemHealth();
        
    } catch (error) {
        console.error('åˆ·æ–°ä»ªè¡¨ç›˜å¤±è´¥:', error);
        Message.error('åˆ·æ–°æ•°æ®å¤±è´¥');
    }
}

function updateStats(stats) {
    // æ›´æ–°ä»»åŠ¡ç»Ÿè®¡
    document.getElementById('totalTasks').textContent = stats.total_tasks || 0;
    document.getElementById('completedTasks').textContent = stats.status_counts.completed || 0;
    document.getElementById('failedTasks').textContent = stats.status_counts.failed || 0;
    
    // æ›´æ–°ä»»åŠ¡ç±»å‹ç»Ÿè®¡
    document.getElementById('qaGenerationTasks').textContent = stats.type_counts.qa_generation || 0;
    document.getElementById('difyTestTasks').textContent = stats.type_counts.dify_test || 0;
    document.getElementById('similarityTasks').textContent = stats.type_counts.similarity_calculation || 0;
    document.getElementById('pipelineTasks').textContent = stats.type_counts.full_pipeline || 0;
    
    // æ›´æ–°æœ€è¿‘ä»»åŠ¡è¡¨æ ¼
    updateRecentTasks(stats.recent_tasks || []);
}

function updateRecentTasks(tasks) {
    const tbody = document.getElementById('recentTasksBody');
    
    if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">æš‚æ— ä»»åŠ¡</td></tr>';
        return;
    }
    
    let html = '';
    tasks.forEach(task => {
        const statusClass = getStatusClass(task.status);
        const statusText = getStatusText(task.status);
        const typeText = getTypeText(task.type);
        
        html += `
            <tr>
                <td>${task.id.substring(0, 8)}...</td>
                <td>${typeText}</td>
                <td><span class="score-badge ${statusClass}">${statusText}</span></td>
                <td>${Utils.formatDate(task.created_at)}</td>
                <td>
                    <a href="/tasks" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">æŸ¥çœ‹è¯¦æƒ…</a>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function updateAgentStatus(agentStatus) {
    const statusElement = document.getElementById('agentStatus');
    
    if (!agentStatus.configured) {
        statusElement.innerHTML = '<span class="score-badge score-medium">æœªé…ç½®</span>';
        return;
    }
    
    const connectedCount = agentStatus.agents.filter(agent => agent.status === 'connected').length;
    const totalCount = agentStatus.agents.length;
    
    if (connectedCount === totalCount) {
        statusElement.innerHTML = `<span class="score-badge score-high">${connectedCount}/${totalCount} å·²è¿æ¥</span>`;
    } else {
        statusElement.innerHTML = `<span class="score-badge score-low">${connectedCount}/${totalCount} å·²è¿æ¥</span>`;
    }
}

function updateFileStats(files) {
    const totalFiles = files.length;
    const excelFiles = files.filter(file => file.type === 'excel').length;
    const totalSize = files.reduce((sum, file) => sum + file.size, 0);
    const latestFile = files.length > 0 ? files[0].name : 'æ— ';
    
    document.getElementById('totalFiles').textContent = totalFiles;
    document.getElementById('excelFiles').textContent = excelFiles;
    document.getElementById('totalFileSize').textContent = Utils.formatFileSize(totalSize);
    document.getElementById('latestFile').textContent = latestFile.length > 20 ? latestFile.substring(0, 20) + '...' : latestFile;
}

function updateSystemHealth() {
    // ç®€å•çš„ç³»ç»Ÿå¥åº·æ£€æŸ¥
    const healthElement = document.getElementById('systemHealth');
    healthElement.innerHTML = '<span class="score-badge score-high">æ­£å¸¸</span>';
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„å¥åº·æ£€æŸ¥é€»è¾‘
}

function getStatusClass(status) {
    const statusMap = {
        'completed': 'score-high',
        'failed': 'score-low',
        'running': 'score-medium',
        'pending': 'score-medium'
    };
    return statusMap[status] || 'score-medium';
}

function getStatusText(status) {
    const statusMap = {
        'completed': 'å·²å®Œæˆ',
        'failed': 'å¤±è´¥',
        'running': 'è¿è¡Œä¸­',
        'pending': 'ç­‰å¾…ä¸­'
    };
    return statusMap[status] || status;
}

function getTypeText(type) {
    const typeMap = {
        'qa_generation': 'é—®ç­”å¯¹ç”Ÿæˆ',
        'dify_test': 'Difyæµ‹è¯•',
        'similarity_calculation': 'ç›¸ä¼¼åº¦è¯„åˆ†',
        'full_pipeline': 'å®Œæ•´æµæ°´çº¿'
    };
    return typeMap[type] || type;
}
</script>
{% endblock %}